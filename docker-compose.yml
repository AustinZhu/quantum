services:
  timescaledb:
    image: timescale/timescaledb:latest-pg18
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-quantum}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-quantum}
      POSTGRES_DB: ${POSTGRES_DB:-quantum}
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./ops/postgres/init.sql:/docker-entrypoint-initdb.d/001-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-quantum} -d ${POSTGRES_DB:-quantum}"]
      interval: 5s
      timeout: 5s
      retries: 20

  redis:
    image: redis:8
    container_name: redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  minio:
    image: minio/minio:latest
    container_name: minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: ["server", "/data", "--console-address", ":9001"]
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  consul:
    image: hashicorp/consul:1.22
    container_name: consul
    command: ["agent", "-dev", "-client=0.0.0.0", "-ui"]
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    volumes:
      - consul_data:/consul/data
    healthcheck:
      test: ["CMD", "consul", "info"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  vault:
    image: hashicorp/vault:1.21
    container_name: vault
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_TOKEN:-root}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    command: ["vault", "server", "-dev", "-dev-root-token-id=${VAULT_TOKEN:-root}"]
    ports:
      - "8200:8200"
    volumes:
      - vault_data:/vault/file
    depends_on:
      consul:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "VAULT_ADDR=http://127.0.0.1:8200 vault status >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 15s

  pgadmin:
    image: dpage/pgadmin4:9.12
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@quantum.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "True"
      PGADMIN_CONFIG_LOGIN_BANNER: '"Quantum - Development Environment"'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      timescaledb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:80/misc/ping', timeout=3).read()"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 20s

  redisinsight:
    image: redis/redisinsight:3.0
    container_name: redisinsight
    ports:
      - "5540:5540"
    volumes:
      - redisinsight_data:/data
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:5540/api/health/ >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:5540/api/health/ >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 20s

  temporal:
    image: temporalio/server:1.29
    container_name: temporal
    command: ["temporal", "server", "start-dev", "--ip", "0.0.0.0"]
    depends_on:
      timescaledb:
        condition: service_healthy
    ports:
      - "7233:7233"
    healthcheck:
      test: ["CMD-SHELL", "temporal operator cluster health --address 127.0.0.1:7233 >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 20s

  temporal-admin-tools:
    image: temporalio/admin-tools:1.29
    container_name: temporal-admin-tools
    environment:
      TEMPORAL_ADDRESS: temporal:7233
    command: ["sleep", "infinity"]
    depends_on:
      temporal:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "temporal operator cluster health --address temporal:7233 >/dev/null 2>&1 || tctl cluster health --address temporal:7233 >/dev/null 2>&1"]
      interval: 20s
      timeout: 10s
      retries: 6
      start_period: 20s

  temporal-ui:
    image: temporalio/ui:latest
    container_name: temporal-ui
    environment:
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_CORS_ORIGINS: http://localhost:3000
    depends_on:
      temporal:
        condition: service_healthy
    ports:
      - "8088:8080"
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:8080/ >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:8080/ >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 20s

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel
    command: ["--config=/etc/otel/config.yaml"]
    volumes:
      - ./ops/otel/collector.yaml:/etc/otel/config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
      - "9464:9464"
      - "13133:13133"
    depends_on:
      tempo:
        condition: service_healthy
      loki:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:13133/ >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:13133/ >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 20s

  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./ops/tempo/tempo.yaml:/etc/tempo.yaml:ro
      - tempo_data:/tmp/tempo
    ports:
      - "3200:3200"
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:3200/ready >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:3200/ready >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 15
      start_period: 20s

  loki:
    image: grafana/loki:latest
    container_name: loki
    command: ["-config.file=/etc/loki/loki.yaml"]
    volumes:
      - ./ops/loki/loki.yaml:/etc/loki/loki.yaml:ro
      - loki_data:/loki
    ports:
      - "3100:3100"
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:3100/ready >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:3100/ready >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 15
      start_period: 20s

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    volumes:
      - ./ops/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      otel-collector:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:9090/-/healthy >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:9090/-/healthy >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 15
      start_period: 20s

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./ops/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./ops/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3001:3000"
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
      tempo:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:3000/api/health >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:3000/api/health >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 15
      start_period: 20s

  algorand-api:
    build:
      context: ./algorand
      dockerfile: Dockerfile
    container_name: algorand-api
    env_file:
      - .env
    environment:
      ALG_SERVER_HOST: 0.0.0.0
      ALG_SERVER_PORT: 8080
    command: ["algorand", "serve-api"]
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
      temporal:
        condition: service_healthy
      otel-collector:
        condition: service_healthy
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/healthz >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  algorand-worker:
    build:
      context: ./algorand
      dockerfile: Dockerfile
    container_name: algorand-worker
    env_file:
      - .env
    command: ["algorand", "run-worker"]
    depends_on:
      algorand-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import pathlib,sys;sys.exit(0 if b'run-worker' in pathlib.Path('/proc/1/cmdline').read_bytes() else 1)"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s

  datafeed-api:
    build:
      context: ./datafeed
      dockerfile: Dockerfile
    container_name: datafeed-api
    env_file:
      - .env
    command: ["/app/datafeed-api"]
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
      temporal:
        condition: service_healthy
    ports:
      - "8081:8081"

  datafeed-worker:
    build:
      context: ./datafeed
      dockerfile: Dockerfile
    container_name: datafeed-worker
    env_file:
      - .env
    command: ["/app/datafeed-worker"]
    depends_on:
      - datafeed-api

  doordash-api:
    build:
      context: ./doordash
      dockerfile: Dockerfile
    container_name: doordash-api
    env_file:
      - .env
    command: ["java", "-jar", "/app/doordash.jar"]
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
      temporal:
        condition: service_healthy
    ports:
      - "8082:8082"
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:8082/healthz >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:8082/healthz >/dev/null; else exit 1; fi"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  doordash-worker:
    build:
      context: ./doordash
      dockerfile: Dockerfile
    container_name: doordash-worker
    env_file:
      - .env
    command: ["java", "-jar", "/app/doordash.jar", "worker"]
    depends_on:
      doordash-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "tr '\\000' ' ' </proc/1/cmdline | grep -q 'worker'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s

  terminal:
    build:
      context: ./terminal
      dockerfile: Dockerfile
    container_name: terminal
    env_file:
      - .env
    depends_on:
      algorand-api:
        condition: service_healthy
      datafeed-api:
        condition: service_started
      doordash-api:
        condition: service_healthy
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "if command -v curl >/dev/null 2>&1; then curl -fsS http://127.0.0.1:3000/health >/dev/null; elif command -v wget >/dev/null 2>&1; then wget -q -O- http://127.0.0.1:3000/health >/dev/null; else exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s

volumes:
  pg_data:
  minio_data:
  consul_data:
  vault_data:
  pgadmin_data:
  redisinsight_data:
  tempo_data:
  loki_data:
  grafana_data:
